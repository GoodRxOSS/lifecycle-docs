---
title: Auto Deploy & Labels
description: How automatic deployments work and how to control environments with labels
tags:
  - deploy
  - auto
  - labels
  - lifecycle-deploy
  - lifecycle-disabled
date: "2025-01-29"
---

import { Callout } from "nextra/components";
import { Mermaid } from "@lifecycle-docs/components";

## Quick Reference

| Label                        | Effect                              | Use When                      |
| ---------------------------- | ----------------------------------- | ----------------------------- |
| `lifecycle-deploy!`          | Deploy environment, rebuild on push | You want to test changes      |
| `lifecycle-disabled!`        | Tear down, block all deploys        | Temporarily pause testing     |
| `lifecycle-keep!`            | Prevent automatic cleanup           | Long-running test environment |
| `lifecycle-status-comments!` | Post status updates to PR           | You want build progress in PR |

**TL;DR:** Set `autoDeploy: true` to deploy on every PR. Use labels for manual control.

---

## Label Precedence

<Mermaid
  chart={`
flowchart TB
    A[Label Evaluation Order] --> B{lifecycle-disabled! present?}
    B -->|YES| C[Environment DISABLED<br/>highest priority]
    B -->|NO| D{lifecycle-deploy! present?}
    D -->|YES| E[Environment ENABLED]
    D -->|NO| F{autoDeploy: true<br/>in lifecycle.yaml?}
    F -->|YES| G[Environment ENABLED]
    F -->|NO| H[Environment DISABLED]
`}
/>

<Callout type="warning">
  `lifecycle-disabled!` always wins. If both deploy and disabled labels are
  present, the environment stays disabled.
</Callout>

---

## Configuration

Enable automatic deployment when PRs are opened:

```yaml filename="lifecycle.yaml"
environment:
  autoDeploy: true
  defaultServices:
    # your services...
```

| Setting                       | Behavior                                                          |
| ----------------------------- | ----------------------------------------------------------------- |
| `autoDeploy: true`            | Deploy automatically when PR opens, add `lifecycle-deploy!` label |
| `autoDeploy: false` (default) | Wait for manual `lifecycle-deploy!` label                         |

---

## Common Patterns

### Pattern 1: Always Deploy (Active Development)

Best for teams that want every PR to have an environment.

```yaml filename="lifecycle.yaml"
environment:
  autoDeploy: true
```

**Flow:** PR opened → Environment deploys → Pushes rebuild automatically

### Pattern 2: On-Demand Deploy (Selective Testing)

Best for high-volume repos where you only test specific PRs.

```yaml filename="lifecycle.yaml"
environment:
  autoDeploy: false
```

**Flow:** PR opened → Nothing happens → Add `lifecycle-deploy!` → Environment deploys

### Pattern 3: Long-Running Test Environment

For environments that need to persist beyond normal TTL cleanup.

1. Add `lifecycle-deploy!` to deploy
2. Add `lifecycle-keep!` to prevent automatic cleanup
3. Environment persists until PR closes or you remove labels

---

## WRONG vs CORRECT Examples

### Expecting deployment without configuration

```yaml filename="lifecycle.yaml"
# WRONG: Missing autoDeploy, nothing deploys automatically
environment:
  defaultServices:
    - name: api
```

```yaml filename="lifecycle.yaml"
# CORRECT: Explicitly enable auto-deploy
environment:
  autoDeploy: true
  defaultServices:
    - name: api
```

### Trying to deploy with disabled label present

```
# WRONG: Both labels present - disabled wins, no deployment
Labels: lifecycle-deploy!, lifecycle-disabled!
Result: Environment torn down
```

```
# CORRECT: Remove disabled label first
Labels: lifecycle-deploy!
Result: Environment deploys
```

### Config in wrong branch

```
# WRONG: lifecycle.yaml only in main branch
PR branch: feature/new-api (no lifecycle.yaml)
Result: Lifecycle cannot read config, deployment fails
```

```
# CORRECT: lifecycle.yaml in PR branch
PR branch: feature/new-api (has lifecycle.yaml)
Result: Lifecycle reads config from PR, deployment succeeds
```

---

## PR Event Behavior

| Event            | Deploy Enabled            | Deploy Disabled       |
| ---------------- | ------------------------- | --------------------- |
| PR opened        | Build & deploy            | Create records only   |
| PR reopened      | Build & deploy            | Create records only   |
| Push commits     | Rebuild affected services | No action             |
| PR closed/merged | Tear down environment     | Tear down environment |

### Label Changes

| Action                       | Result                                                      |
| ---------------------------- | ----------------------------------------------------------- |
| Add `lifecycle-deploy!`      | Set `deployOnUpdate=true`, trigger build                    |
| Remove `lifecycle-deploy!`   | Set `deployOnUpdate=false`, tear down                       |
| Add `lifecycle-disabled!`    | Set `deployOnUpdate=false`, tear down, block future deploys |
| Remove `lifecycle-disabled!` | Restore previous deploy state                               |

---

## Troubleshooting

| Problem                             | Solution                                                                                        |
| ----------------------------------- | ----------------------------------------------------------------------------------------------- |
| PR opened but no deployment         | Verify `autoDeploy: true` in `lifecycle.yaml` on PR branch, or add `lifecycle-deploy!` manually |
| Environment torn down unexpectedly  | Check for `lifecycle-disabled!` label; verify PR is still open                                  |
| Pushes not triggering rebuilds      | Ensure `lifecycle-deploy!` label present and `lifecycle-disabled!` absent                       |
| Can't deploy even with deploy label | Remove `lifecycle-disabled!` label (it takes precedence)                                        |

---

## Quick Decision Guide

| I want to...                    | Do this                                                            |
| ------------------------------- | ------------------------------------------------------------------ |
| Deploy every PR automatically   | Set `autoDeploy: true`                                             |
| Deploy only specific PRs        | Keep `autoDeploy: false`, add `lifecycle-deploy!` when needed      |
| Stop deploying a PR             | Remove `lifecycle-deploy!` or add `lifecycle-disabled!`            |
| Prevent accidental redeployment | Add `lifecycle-disabled!` (blocks deploy label too)                |
| Keep environment alive longer   | Add `lifecycle-keep!`                                              |
| See build status in PR          | Add `lifecycle-status-comments!`                                   |
| Tear down an environment        | Close PR, remove `lifecycle-deploy!`, or add `lifecycle-disabled!` |
