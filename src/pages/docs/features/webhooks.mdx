---
title: Webhooks
description: Trigger automated tasks when build states change
tags:
  - webhook
  - automation
  - codefresh
  - deployment
  - docker
  - command
date: "2025-01-29"
---

import { Callout, Tabs } from "nextra/components";
import { Mermaid } from "@lifecycle-docs/components";

# Webhooks

Automate external processes when your build state changes—run tests, send notifications, or perform cleanup tasks.

## Quick Reference

| Type        | Best For                        | Key Config                        |
| ----------- | ------------------------------- | --------------------------------- |
| `codefresh` | Existing CI/CD pipelines        | `pipelineId`, `trigger`           |
| `docker`    | Custom containers, full control | `docker.image`, `docker.command`  |
| `command`   | Quick scripts, notifications    | `command.image`, `command.script` |

**Trigger States:** `deployed` | `error` | `torn_down`

<Callout type="info">
  Webhook failures do **not** affect your build status—failures are recorded but
  deployments continue.
</Callout>

---

## How It Works

<Mermaid chart={`
flowchart TB
    A["Build State Changes<br/>(deployed / error / torn_down)"]
    B["Lifecycle checks for webhooks<br/>matching that state"]
    C["Webhooks execute serially in order"]
    D["Results recorded<br/>(view at /builds/[uuid]/webhooks)"]

    A --> B
    B --> C
    C --> D

`} />

---

## Configuration by Type

### Codefresh Webhook

Trigger existing Codefresh CI/CD pipelines.

```yaml
environment:
  webhooks:
    - name: "E2E Tests"
      state: deployed
      type: codefresh
      pipelineId: 64598362453cc650c0c9cd4d
      trigger: tests
      env:
        branch: "{{frontend_branchName}}"
        TEST_URL: "https://{{frontend_publicUrl}}"
```

| Field        | Required | Description            |
| ------------ | -------- | ---------------------- |
| `pipelineId` | Yes      | Codefresh pipeline ID  |
| `trigger`    | Yes      | Codefresh trigger name |

### Docker Webhook

Execute a Docker image as a Kubernetes job—best for custom containers.

```yaml
environment:
  webhooks:
    - name: "E2E Test Suite"
      state: deployed
      type: docker
      docker:
        image: "myorg/e2e-tests:latest"
        command: ["npm", "run", "e2e"]
        args: ["--headless", "--ci"]
        timeout: 3600
      env:
        BASE_URL: "https://{{frontend_publicUrl}}"
```

| Field            | Required | Default | Description                   |
| ---------------- | -------- | ------- | ----------------------------- |
| `docker.image`   | Yes      | —       | Docker image to execute       |
| `docker.command` | No       | —       | Override container entrypoint |
| `docker.args`    | No       | —       | Arguments for the command     |
| `docker.timeout` | No       | 1800s   | Max execution time            |

### Command Webhook

Run a shell script in a container—ideal for quick tasks.

```yaml
environment:
  webhooks:
    - name: "Slack Notification"
      state: deployed
      type: command
      command:
        image: "curlimages/curl:latest"
        script: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"Deployed $SERVICE to $URL\"}"
        timeout: 60
      env:
        SLACK_WEBHOOK: "https://hooks.slack.com/services/XXX"
        SERVICE: "{{frontend_internalHostname}}"
        URL: "https://{{frontend_publicUrl}}"
```

| Field             | Required | Default | Description                       |
| ----------------- | -------- | ------- | --------------------------------- |
| `command.image`   | Yes      | —       | Docker image for script execution |
| `command.script`  | Yes      | —       | Shell script to execute           |
| `command.timeout` | No       | 1800s   | Max execution time                |

---

## Common Fields (All Types)

| Field         | Required | Description                         |
| ------------- | -------- | ----------------------------------- |
| `name`        | No       | Human-readable identifier           |
| `description` | No       | What the webhook does               |
| `state`       | Yes      | `deployed`, `error`, or `torn_down` |
| `type`        | Yes      | `codefresh`, `docker`, or `command` |
| `env`         | Yes      | Environment variables (can be `{}`) |

---

## Template Variables

Inject build-specific values using `{{variable}}` syntax:

| Variable                           | Example Output                         |
| ---------------------------------- | -------------------------------------- |
| `{{serviceName_publicUrl}}`        | `my-service-abc123.example.com`        |
| `{{serviceName_branchName}}`       | `feature/my-branch`                    |
| `{{serviceName_internalHostname}}` | `my-service.namespace.svc`             |
| `{{serviceName_dockerImage}}`      | `myorg/service:sha-abc123`             |
| `{{serviceName_sha}}`              | `abc123def456`                         |
| `{{buildUUID}}`                    | `550e8400-e29b-41d4-a716-446655440000` |
| `{{namespace}}`                    | `lifecycle-pr-123`                     |
| `{{pullRequestNumber}}`            | `123`                                  |

Replace `serviceName` with your actual service name from the Lifecycle config.

---

## Common Mistakes

### Wrong: Missing env field

```yaml
# WRONG - env field is required even if empty
environment:
  webhooks:
    - name: "Test"
      state: deployed
      type: docker
      docker:
        image: "myorg/tests:latest"
```

```yaml
# CORRECT - include env: {} if no variables needed
environment:
  webhooks:
    - name: "Test"
      state: deployed
      type: docker
      docker:
        image: "myorg/tests:latest"
      env: {}
```

### Wrong: Template variable typo

```yaml
# WRONG - service name doesn't match config
env:
  URL: "https://{{frontEnd_publicUrl}}" # Wrong: "frontEnd" vs "frontend"
```

```yaml
# CORRECT - use exact service name from your lifecycle.yaml
env:
  URL: "https://{{frontend_publicUrl}}"
```

### Wrong: No timeout for long-running jobs

```yaml
# WRONG - E2E tests may exceed 30-minute default
docker:
  image: "mcr.microsoft.com/playwright:latest"
  command: ["npx", "playwright", "test"]
```

```yaml
# CORRECT - set appropriate timeout
docker:
  image: "mcr.microsoft.com/playwright:latest"
  command: ["npx", "playwright", "test"]
  timeout: 3600 # 1 hour for comprehensive E2E suite
```

---

## Practical Patterns

### E2E Tests After Deployment

```yaml
environment:
  webhooks:
    - name: "Playwright E2E Tests"
      state: deployed
      type: docker
      docker:
        image: "mcr.microsoft.com/playwright:v1.40.0"
        command: ["npx", "playwright", "test"]
        timeout: 1800
      env:
        BASE_URL: "https://{{frontend_publicUrl}}"
        CI: "true"
```

### Slack + Discord Notifications

```yaml
environment:
  webhooks:
    - name: "Slack Deploy Alert"
      state: deployed
      type: command
      command:
        image: "curlimages/curl:8.5.0"
        script: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{"text":"Deployed: '"$URL"'"}'
        timeout: 30
      env:
        SLACK_WEBHOOK: "https://hooks.slack.com/services/XXX"
        URL: "https://{{frontend_publicUrl}}"

    - name: "Discord Error Alert"
      state: error
      type: command
      command:
        image: "curlimages/curl:8.5.0"
        script: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{"content":"Build failed for PR #'"$PR"'"}'
        timeout: 30
      env:
        DISCORD_WEBHOOK: "https://discord.com/api/webhooks/XXX"
        PR: "{{pullRequestNumber}}"
```

### Database Migrations

```yaml
environment:
  webhooks:
    - name: "Run Migrations"
      state: deployed
      type: docker
      docker:
        image: "myorg/db-migrator:latest"
        command: ["./migrate.sh", "up"]
        timeout: 600
      env:
        DATABASE_URL: "postgres://{{db_internalHostname}}:5432/app"
```

### Cleanup on Teardown

```yaml
environment:
  webhooks:
    - name: "Cleanup External Resources"
      state: torn_down
      type: docker
      docker:
        image: "myorg/cleanup-tool:latest"
        timeout: 300
      env:
        BUILD_UUID: "{{buildUUID}}"
```

---

## Resource Limits

| Resource | Request | Limit |
| -------- | ------- | ----- |
| CPU      | 200m    | 200m  |
| Memory   | 1Gi     | 1Gi   |

| Timeout        | Default              | Maximum  |
| -------------- | -------------------- | -------- |
| Docker/Command | 30 min               | 24 hours |
| Codefresh      | Managed by Codefresh | N/A      |

---

## Troubleshooting

| Problem                            | Solution                                                      |
| ---------------------------------- | ------------------------------------------------------------- |
| Webhook not triggering             | Verify `state` matches the build state (check spelling)       |
| Template variable empty            | Confirm service name matches exactly in your `lifecycle.yaml` |
| Timeout exceeded                   | Increase `timeout` value; check if job is stuck               |
| Image pull error                   | Verify image exists and is accessible from cluster            |
| Script syntax error                | Test script locally before deploying                          |
| Webhook failed but build succeeded | Expected—webhook failures don't affect builds                 |

View webhook history at `/builds/[uuid]/webhooks` to debug failures.

---

## Summary: When to Use Each Type

| Use Case                    | Recommended Type | Why                                  |
| --------------------------- | ---------------- | ------------------------------------ |
| Run existing CI/CD pipeline | `codefresh`      | Native integration, managed timeouts |
| Custom test suite           | `docker`         | Full control over image and commands |
| Send notifications          | `command`        | Quick, lightweight scripts           |
| Database migrations         | `docker`         | Reliable execution with custom tools |
| Cleanup external resources  | `docker`         | Access to custom tooling             |
| Health checks               | `command`        | Simple curl/wget scripts             |
